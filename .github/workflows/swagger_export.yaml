name: Commit new Swagger files to exo_documentation
on:
- push
jobs:
  get_and_commit_swagger_export_files:
    runs-on: ubuntu-latest
    env:
      TARGET_FOLDER: "docs"
      SERVER_URL: "https://repository.exoplatform.org"
      PREFIX: "service/local/artifact/maven/redirect?"
      url: 
           r=exo-snapshots&g=org.exoplatform.commons&a=commons-component-common&v=6.4.x-devx-SNAPSHOT&c=swagger&e=json
           r=exo-snapshots&g=org.exoplatform.social&a=social-component-service&v=6.4.x-devx-SNAPSHOT&c=swagger&e=json
           r=exo-snapshots&g=org.exoplatform.gatein.portal&a=exo.portal.component.portal&v=6.4.x-devx-SNAPSHOT&c=swagger&e=json
           r=exo-snapshots&g=org.exoplatform.ecms&a=ecms-core-services&v=6.4.x-devx-SNAPSHOT&c=swagger&e=json
           r=exo-addons-snapshots&g=org.exoplatform.addons.dlp&a=dlp-services&v=1.0.x-devx-SNAPSHOT&c=swagger&e=json
           r=exo-addons-snapshots&g=org.exoplatform.anti-malware&a=anti-malware-services&v=1.0.x-devx-SNAPSHOT&c=swagger&e=json
    steps:
      # Check-out the repository under $GITHUB_WORKSPACE
      - uses: actions/checkout@v2

      - name: Download nexus metadata
        run: |
         cd $TARGET_FOLDER
         mkdir -p swagger
         pushd swagger
         for item in ${url}
         do
          file_name=$(echo ${item} | grep -o -P '(?<=m.).*(?=&a)')
          final_name=${file_name//./_}
         STATUSCODE=$(curl -s -L ${SERVER_URL}/${PREFIX}${item} --write-out '%{http_code}' --output ${final_name}_swagger.json)
         if test $STATUSCODE -ne 200; then
           echo "ERROR: ${final_name}_swagger.json : download Error. Status code : ${STATUSCODE}"
           echo ${SERVER_URL}/${PREFIX}${item} 
           echo "No files downloaded : nothing to commit"
           exit 1
         else
           echo "${final_name}_swagger.json download OK"
         fi
         done
         cd $GITHUB_WORKSPACE
           git status
           git config --global user.email "exo-swf@exoplatform.com"
           git config --global user.name "eXo Software Factory"
           git add -A
           git diff-index --quiet HEAD || git commit -m "Automated swagger exports commit"
           git push
